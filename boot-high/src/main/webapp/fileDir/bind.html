<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="UTF-8">
    <script src="./js/jquery.min.js"></script>

    <title>数据绑定工具</title>
    <style type="text/css">
        .bind {
            height: auto;
            width: 100%;
            border: 1px solid #000;
        }

        .bind_title {
            font-size: larger;
            font-weight: 900;
            height: 30px;
            width: 10%;
            font-family: "Microsoft YaHei UI";
            float: left;
        }

        .bind_table {
            height: auto;
            border-top: 1px solid #000;
            width: 80%;
            float: left;
        }

        .bind_preview {
            height: auto;
            width: 17%;
            border-left: 1px solid #000;
            float: left;
            padding-left: 20px;
            padding-right: 20px;
            text-align: center
        }

        .select_ca {
            float: left;
            width: 400px;
            height: 28px;
            font-size: medium;
        }

        .dataTable {
            border: 1px solid #000;
            width: 100%;
            height: auto;
            border-collapse: collapse;
        }

        .dataTable_preview {
            border: 1px solid #000;
            width: 100%;
            height: auto;
            border-collapse: collapse;
            margin-bottom: 30px;
            margin-left: 10px;
            text-align: center
        }

        .dataTable_preview td {
            border: 1px solid #000;
            width: 50%;
            height: 40px;
        }

        .dataTable td {
            border: 1px solid #000;
            height: 40px;
        }

        .bind_table_title {

            height: 5%;
            padding-top: 20px;
            float: left;
            background-color: #EEE0E5;
            border-right: 1px solid #F0F8FF;
            font-weight: bold;
            text-align: center

        }

        .target_Fields {
            width: 25%;
            height: 100%;
            font-size: medium;
        }

        .target_fields_link {
            width: 25%;
            height: 100%;
            font-size: medium;
        }

        .deleteButton {
            float: right
        }

        .deleteButtonL {
            float: right
        }

        .target_preview_title {
            font-weight: bold;
            height: 10%;
            padding-top: 20px;
        }
    </style>

</head>
<body onload="loadDb()">
<div align="center" style="font-size: 30px;">
    数据绑定工具
</div>
<h3>第一步：选择数据库连接</h3>
<HR>
<div style="height:130px">
    选择数据连接：<select id="dbSelect" style="width: 300px;"></select>&emsp;<button id="createNewDb">创建连接</button>
    </br>
    <div hidden id="newDbInfo">
        <fieldset>
            <legend>创建连接</legend>
            数据库名称：<input type="text" value="" id="dbName">&nbsp;
            数据库类型：<select id="dbType">
            <option value="mysql">mysql</option>
            <option value="oracle">oracle</option>
            <option value="postgresql">postgresql</option>
            <option value="tidb">tidb</option>
        </select>&nbsp;
            ip：<input type="text" value="" id="ip"/>&nbsp;
            端口号：<input type="text" value="" id="port"/>&nbsp;
            库名：<input type="text" value="" id="serverName"/>&nbsp;
            模式：<input type="text" value="" id="dbSchemaName" placeholder="postgrep数据库才填写"/>&nbsp;
            <label id="relkindLabel" hidden>表类型：</label><select id="dbRelkind" hidden>
            <option value="r" selected>表</option>
            <option value="v">视图</option>
        </select>
            </br>
            <HR>
            数据库用户名：<input type="text" value="" id="username"/>&nbsp;
            数据库密码：<input type="text" value="" id="password"/>&nbsp;
            <input type="submit" id="doSave" value="保存">
        </fieldset>
    </div>
</div>
<h3>第二步：选择目标表</h3>
<div style="float:left;">
    表名：<input id="tableName" type="text" value="" placeholder="输入模糊匹配的表名"/>
    <input type="submit" id="search" value="查询"/>
    <hr>
    <table border="1" id="tableLabel">

    </table>

</div>
<div style=" float:left;width: 100%;">
    <h3>1）主表<label id="preTableName"></label>&nbsp;详情预览&emsp;&emsp;<button onclick="removeLinkTable()">去除关联表</button></h3>
    <table border="1" id="targetTable" bgcolor="#f0ffff" align="center">

    </table>
</div>
<div style=" float:left;width: 100%;">
    <h3>2）关联表<label id="linkTableName"></label>&nbsp;详情预览</h3>
    <table border="1" id="linkTargetTable" bgcolor="#f0ffff" align="center">

    </table>
    <br>
</div>

<div style="float: left;width: 100%">
    <h3>第三步：绑定</h3>
    <div class="bind_title">获取本体及关系列表</div>
    <select id="categoryList" class="select_ca" name="selectCategory" onchange="showCategoryDetail()">

    </select>
    <input id="condition" type="text" value="" placeholder="输入name或描述"/>
    <input type="submit" onclick="getCategoryData()" value="查询"/>&emsp;

    <!--            <label style="margin-left: 100px">选择排序: &nbsp; </label>
               <select id ='sort' style="width:200px;height: 28px;font-size: medium " ></select>-->
    <label id='personTypeLabel' style="visibility: hidden"> &nbsp;
        选择人员类别：
        <select id='personType' style="width:100px;height: 28px;font-size: medium ">
            <!--<option value="99" selected="selected">正常人员</option>-->
            <!--<option value="10">重点人员</option>-->
            <!--<option value="11">前科人员</option>-->
            <!--<option value="12">涉毒人员</option>-->
            <!--<option value="13">吸毒人员</option>-->
            <!--<option value="14">经济案人员</option>-->
        </select>
    </label>
    <button onclick="bindData()" style="float: right;margin-right: 10%;width: 100px;height:28px;font-size: medium">绑
        &nbsp;定
    </button>
</div>
<div style="float: left;width: 100%;height: auto">
    <input id="addLabelId" type="button" onclick="addLabel()" value="添加标签+" />
    <p></p>
    <fieldset>
        <table id="labelTable">

        </table>
    </fieldset>
</div>
</br>
<div style="float:left;width: 100%">
    <div id="categoryName" style="width: 30%" class="bind_table_title">--本体或关系属性--</div>
    <div id="targetName" style="width: 69.8%" class="bind_table_title">--目标表列--</div>
</div>
<div class="bind" style="float: left">
    <div style="width: 100%">
        <h3>主表字段绑定</h3>
    </div>
    <div class="bind_table">
        <table id="dataTable" class="dataTable">

        </table>
    </div>
    <div class="bind_preview">
        <div class="target_preview_title"> 列数据预览</div>
        <table id="data_preview" class="dataTable_preview">

        </table>

    </div>

</div>
<div style="float: left;width: 100%" id="linkField" hidden>
    <h3>关联</h3>
    <fieldset>
        <legend></legend>
        <select id="primaryTableKey"></select><===>
        <select id="linkTablekey"></select>
    </fieldset>
    <h3></h3>
</div>
<div style="float:left;width: 100%" hidden id="linkShowTitle">
    <div id="linkCategoryName" style="width: 30%" class="bind_table_title">--选择关联本体或关系--</div>
    <div id="linkTargetName" style="width: 69.8%" class="bind_table_title">--选择关联目标表--</div>
</div>
<div class="bind" style="float: left" hidden id="linkShowTable">
    <h3>关联表字段绑定</h3>
    <div class="bind_table">
        <table id="linkDataTable" class="dataTable">

        </table>
    </div>
    <div class="bind_preview">
        <div class="target_preview_title"> 列数据预览</div>
        <table id="linkDataPreview" class="dataTable_preview">

        </table>
    </div>
</div>
<div  style="float: left;width: 100%;height: auto">
    <h3>过滤条件</h3>
    </HR>
    <input type="button" onclick="addFilter()" value="添加主表过滤条件+" />&emsp;&emsp;<input type="button" onclick="addLinkFilter()" value="添加关联表过滤条件+" />
    <p></p>
    <fieldset>
        <legend>主表过滤条件</legend>
        <table  id="filterTable">

        </table>
    </fieldset>
    <fieldset>
        <legend>关联表过滤条件</legend>
        <table  id="linkFilterTable">

        </table>
    </fieldset>
</div>
<div  style="float: left;width: 100%;height: auto">
    <h3>附加属性</h3>
    </HR>
    <input id="startAttachButton" type="button" onclick="addStartAttach()" value="添加开始节点附加属性+" />&emsp;<input id="endAttachButton" type="button" onclick="addEndAttach()" value="添加结束节点附加属性+" />
    <p></p>
    <fieldset>
        <legend>开始节点<label id="startNodeDesc"></label>属性</legend>
        <table  id="startAttachTable">

        </table>
    </fieldset>
    <fieldset>
        <legend>结束节点<label id="endNodeDesc"></label>属性</legend>
        <table  id="endAttachTable">

        </table>
    </fieldset>
</div>
<div style="float:left;height:200px;display:block">
    <p>-------</p>
    <p>----------</p>
    <p>-------------</p>
</div>
</body>
<script type="text/javascript">

    var url = "http://localhost:8080";
    getCategoryData();

    /*
   * 装载数据库连接
   * */
    function loadDb() {
        $.ajax({
            type: "post",
            url: url + "/category/getSysDbInfoList",
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    alert('返回值为空!');
                }
                var dbSelect = $("#dbSelect");
                dbSelect.append("<option value=\"\">请选择</option>");
                for (var i = 0; i < output.length; i++) {
                    dbSelect.append("<option value='" + output[i]["dbinfoId"] + "' sc='" + output[i]["dbTableSchema"] + "'>" + output[i]["dbName"] + "</option>");
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }
        });
        //人员类别列表
        getPersonTypeList();
    }


    $(function () {
        /*
        * 创建新连接
        * */
        $("#createNewDb").click(function () {
            $("#newDbInfo").show();
        })

        /*
        * 根据选择的数据库类型，是否展示视图还是表
        * */
        $("#dbType").change(function () {
            var dbType = $("#dbType").val();
            if(dbType=='postgresql'){
                $("#dbRelkind").show();
                $("#relkindLabel").show();
            }else {
                $("#dbRelkind").hide();
                $("#relkindLabel").hide();
            }

        })

        /**
         * 保存连接
         */
        $("#doSave").click(function () {
            var dbName = $("#dbName").val();
            var dbType = $("#dbType").val();
            var ip = $("#ip").val();
            var port = $("#port").val();
            var serverName = $("#serverName").val();
            var username = $("#username").val();
            var password = $("#password").val();
            var dbInfo = {
                dbName: dbName,
                dbType: dbType,
                dbIp: ip,
                dbPort: port,
                dbServerName: serverName,
                dbUser: username,
                dbPassword: password
            }
            /*
            * 如果是postgresql设置表类型
            * */
            if(dbType=='postgresql'){
                dbInfo.dbRelkind = $("#dbRelkind").val();
                dbInfo.dbTableSchema = $("#dbSchemaName").val();
            }

            $.ajax({
                type: "post",
                url: url + "/category/saveDbInfo",
                data: dbInfo,
                dataType: 'json',
                cache: false,
                success: function (output) {

                    if (output == 1) {
                        //保存成功
                        // $("#doSave").attr("disabled",true);
                        //重新装载连接
                        $("#dbSelect").html("");
                        loadDb();
                        $("#dbName").val("");
                        $("#dbType").val("mysql");
                        $("#ip").val("");
                        $("#port").val("");
                        $("#serverName").val("");
                        $("#dbSchemaName").val("");
                        $("#username").val("");
                        $("#password").val("");
                        $("#dbRelkind").hide();
                        $("#relkindLabel").hide();
                        alert("保存成功");
                    } else {
                        alert("保存失败");
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("保存数据异常");
                }
            });
        });

        /**
         * 监听选中的数据库，根据数据库id获取所有的数据库表
         */
        $("#dbSelect").change(function () {
            // $("#tableLabel").html("");
            var dbId = $(this).val();
            if (dbId != '' && dbId != undefined) {
                $("#search").attr("disabled", false);
                getTableS(dbId, 1, 10);
            } else {
                $("#search").attr("disabled", true);
            }
        });



        $("#search").click(function () {
            var tableName = $("#tableName").val();
            var dbId = $("#dbSelect").val();
            getTableS(dbId, 1, 10, tableName);
        })

    })


    /*
    * 获取人员类别列表
    * */
    function getPersonTypeList() {
        $.ajax({
            type: "post",
            url: url + "/category/findPersonTopTags",
            dataType: 'json',
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    // alert('返回值为空!');
                } else {
                    $("#personType").empty();
                    var personTypeE ="<option value=''>---请选择---</option>";
                    if(output.length>0) {
                        for(var i=0;i<output.length;i++) {
                            personTypeE +="<option value='"+output[i]["id"]+"'>"+output[i]['showName']+"</option>";
                        }
                    }
                    $("#personType").append(personTypeE);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("操作异常");
            }
        });


    }

    /**
     * 分页查询
     * @param dbId
     * @param pageNo
     * @param pageSize
     * @param tableName
     */
    function getTableS(dbId, pageNo, pageSize, tableName) {
        $("#tableLabel").html("");
        if (pageNo == undefined) {
            pageNo = 1;
        }
        if (pageSize == undefined) {
            pageSize = 10;
        }

        var db_url = "dbId=" + dbId + "&pageNo=" + pageNo + "&pageSize=" + pageSize;
        if (tableName != 'undefined' && tableName != undefined && tableName != '') {
            db_url = db_url + "&tableName=" + tableName;
        }

        $.ajax({
            type: "post",
            url: url + "/category/getAllTablesByDbId?" + db_url,
            dataType: 'json',
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    alert('返回值为空!');
                } else {
                    console.log(output);
                    var totalNum = output["total"];
                    var totalPage = output["totalPage"];
                    var result = output["dataList"];
                    var tableLabel = $("#tableLabel");
                    tableLabel.append("<tr align='center'><td>表名</td><td>中文名</td><td>操作</td></tr>")
                    for (var i = 0; i < result.length; i++) {
                        var str = "<tr align='center'><td>" + result[i]["tableEname"] + "</td><td>" + result[i]["tableCname"] + "</td><td><a href='#' onclick='selectTable(\"" + result[i]["tableEname"] + "\",\"" + result[i]["tableCname"] + "\",\"" + dbId + "\")'>主表选择</a>&nbsp;|&nbsp;<a href='#' onclick='selectLinkTable(\"" + result[i]["tableEname"] + "\",\"" + result[i]["tableCname"] + "\",\"" + dbId + "\")'>关联表选择</a></td></tr>";
                        tableLabel.append(str);
                    }

                    var prePage = pageNo - 1 <= 0 ? pageNo : pageNo - 1;
                    var nextPage = pageNo + 1 > totalPage ? totalPage : pageNo + 1;
                    var foot = "<tr align='center'><td colspan=\"3\">当前第" + pageNo + "页&nbsp;&nbsp;共" + totalPage + "页&nbsp;<a href='#' onclick='getTableS(" + dbId + "," + prePage + "," + pageSize + ",\"" + tableName + "\")'>上一页</a>&nbsp;<a href='#' onclick='getTableS(" + dbId + "," + nextPage + "," + pageSize + ",\"" + tableName + "\")'>下一页</a></td></tr>";
                    tableLabel.append(foot);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据数据异常");
            }
        });
    }


    /**
     * 选择表
     */
    function selectTable(tableName, tableCName, dbId) {
        $("#targetTable").html("");
        $("#preTableName").html("");
        $("#preTableName").attr("cname", "");
        $("#preTableName").attr("cname", tableCName);
        $.ajax({
            type: "post",
            url: url + "/category/getColumnListBy?tableName=" + tableName + "&dbId=" + dbId,
            dataType: 'json',
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    alert('返回值为空!');
                } else {
                    $("#preTableName").html(tableName);
                    var header = output["columnList"];
                    var targetTable = $("#targetTable");
                    var str = "<tr align='center'>";
                    for (var i = 0; i < header.length; i++) {
                        str += "<td>" + header[i] + "</td>";
                    }
                    str += "</tr>";
                    targetTable.append(str);
                    var dataList = output["dataList"]
                    for (var j = 0; j < dataList.length; j++) {
                        var d = dataList[j];
                        var colStr = "<tr align='center'>";
                        for (var m = 0; m < d.length; m++) {
                            colStr += "<td>" + d[m] + "</td>";
                        }
                        colStr += "</tr>";
                        targetTable.append(colStr);
                    }

                    //清空过滤条件
                    $("#filterTable").empty();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据数据异常");
            }
        });

    }

    /*
    * 选择关联表
    * */
    function selectLinkTable(tableName, tableCName, dbId) {

        var preTableName = $("#preTableName").html();
        if(preTableName==''||preTableName==undefined){
            alert("请先选择主表");
            return;
        }

        $("#linkTargetTable").html("");
        $("#linkTableName").html("");
        $("#linkTableName").attr("cname", "");
        $("#linkTableName").attr("cname", tableCName);
        $.ajax({
            type: "post",
            url: url + "/category/getColumnListBy?tableName=" + tableName + "&dbId=" + dbId,
            dataType: 'json',
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    alert('返回值为空!');
                } else {
                    $("#linkTableName").html(tableName);
                    var header = output["columnList"];
                    var targetTable = $("#linkTargetTable");
                    var str = "<tr align='center'>";
                    for (var i = 0; i < header.length; i++) {
                        str += "<td>" + header[i] + "</td>";
                    }
                    str += "</tr>"
                    targetTable.append(str);
                    var dataList = output["dataList"];
                    for (var j = 0; j < dataList.length; j++) {
                        var d = dataList[j];
                        var colStr = "<tr align='center'>";
                        for (var m = 0; m < d.length; m++) {
                            colStr += "<td>" + d[m] + "</td>";
                        }
                        colStr += "</tr>";
                        targetTable.append(colStr);
                    }

                    /*
                    * 关联下拉属性
                    * */
                    $("#primaryTableKey").empty();
                    $("#linkTablekey").empty();

                    var itemFields = "<option value=''>==请选择==</option>";
                    $("#targetTable tr:first").find("td").each(function (i) {
                        var str = $(this).html();
                        itemFields += "<option  id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
                    })

                    $("#primaryTableKey").append(itemFields);
                    var itemFieldsE = "<option value=''>==请选择==</option>";
                    $("#linkTargetTable tr:first").find("td").each(function (i) {
                        var str = $(this).html();
                        itemFieldsE += "<option  id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
                    })
                    $("#linkTablekey").append(itemFieldsE);

                    //清空主表元素
                    $("#dataTable").empty();
                    $("#linkDataTable").empty();
                    $("#categoryList").val("-1");
                    //清空过滤条件
                    $("#filterTable").empty();
                    $("#linkFilterTable").empty();

                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据数据异常");
            }
        });





        //展示连接
        $("#linkField").show();

        //显示关联表绑定属性
        $("#linkShowTitle").show();
        $("#linkShowTable").show();




    }




    /*
     *获得所有本体或关系
     * */
    function getCategoryData() {
        $.ajax({
            type: "post",
            url: url + "/category/caList",
            cache: false,
            success: function (data) {
                if (data == "" || data == undefined) {
                    alert('返回值为空!');
                } else {
                    fillingSelects(data.data);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }
        });
    }

    /*
     * 填充选择器
     * */
    function fillingSelects(data) {
        $("#categoryList").empty();
        $("#categoryList").append("<option value=\"-1\" selected=\"selected\">--请选择--</option>");
        if (data.length > 0) {
            var condition = $("#condition").val();
            //如果有查询条件，判断是否包含在内
            if (condition != '' && condition != undefined) {
                for (var i = 0; i < data.length; i++) {
                    if (data[i].description.indexOf(condition)!=-1||data[i].name.indexOf(condition)!=-1) {
                        var text = "<option  value='" + data[i].subcategoryinfoId + "' parentId='" + data[i].categoryinfoId + "'>" + data[i].description + "   --   " + data[i].name + "</option>";
                        $("#categoryList").append(text);
                    }
                }
            } else {
                for (var i = 0; i < data.length; i++) {
                    var text = "<option  value='" + data[i].subcategoryinfoId + "' parentId='" + data[i].categoryinfoId + "'>" + data[i].description + "   --   " + data[i].name + "</option>";
                    $("#categoryList").append(text);
                }
            }

        }


    }

    /*附件节点的开始和结束节点下拉*/
    var beginNodeSelect = "";
    var endNodeSelect = "";

    /*
     * 获得一条本体或者关系的数据
     * */
    function showCategoryDetail() {
        /*
        * 小类id
        * */
        var num = $("#categoryList").val();
        var parentId = $("#categoryList").children("option:selected").attr("parentId");
        $("#personTypeLabel").css("visibility", "hidden")
        if (parentId == "1100") {
            $("#personTypeLabel").css("visibility", "visible")
        }

        $.ajax({
            type: "post",
            url: url + "/category/oneCa",
            data: num,
            contentType: 'application/json;charset=utf-8',
            cache: false,
            success: function (data) {
                if (data == "" || data == undefined) {
                    alert('返回值为空!');
                } else {
                    console.log(data);

                    /*
                   * 判断是否有主表
                   * */
                    var preTableName = $("#preTableName").html();
                    if(preTableName!=''&&preTableName!=undefined){
                        $("#categoryName").html(data.data.name + " - " + data.data.description).attr("num", data.data.subcategoryinfoId)
                            .attr("type", data.data.ctype);
                        $("#targetName").html($("#preTableName").html());

                        /*显示字段详情*/
                        showCategoryFieldDetail();

                        /*如果小类是关系时，下拉开始节点和结束节点*/
                        if(data.data.ctype==1) {
                            setStartNodeAndEndNodeSelect(num);
                            attachFieldSelect();
                            $("#startAttachButton").removeAttr("disabled");
                            $("#endAttachButton").removeAttr("disabled");
                        }else{
                            beginNodeSelect = "";
                            endNodeSelect = "";
                            attachFieldSelectE='';
                            $("#startAttachButton").attr("disabled", true);
                            $("#endAttachButton").attr("disabled", true);
                            //清空开始节点和结束节点的描述
                            $("#startNodeDesc").html("");
                            $("#endNodeDesc").html("");

                        }

                        //获取顶级标签
                        selectTopLabel(parentId);

                    }
                    /*
                    * 判断是否有关联表
                    * */
                    var linkTableName = $("#linkTableName").html();
                    if(linkTableName!=''&&linkTableName!=undefined){
                        $("#linkCategoryName").html(data.data.name + " - " + data.data.description).attr("num", data.data.subcategoryinfoId)
                            .attr("type", data.data.ctype);
                        $("#linkTargetName").html($("#linkTableName").html());

                    }

                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }
        });
    }

    /*
     * 展示本体或者关系字段
     * */
    function showCategoryFieldDetail() {
        var id = $("#categoryName").attr("num");
        $.ajax({
            type: "post",
            url: url + "/category/oneCaFields",
            data: id,
            contentType: 'application/json;charset=utf-8',
            cache: false,
            success: function (data) {
                if (data == "" || data == undefined) {
                    alert('返回值为空!');
                } else {
                    $("#dataTable").html("");
                    var item = "";
                    $.each(data.data, function (i, n) {
                        item += "<tr>" +
                            "<td style='width: 30%' ><label>" + n.fieldDes + "-" + n.fieldName + "</label><button  class='deleteButton' >删除</button></td>" +
                            "<td style='width: 70%'> <select id ='targetFields' class='target_Fields'></select><label></label></td>" +
                            "</tr>";
                    })

                    $("#dataTable").append(item);
                    var itemFields = "";
                    $("#targetTable tr:first").find("td").each(function (i) {
                        var str = $(this).html();

                        itemFields += "<option align='center' id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
                    })

                    $(".target_Fields").each(function () {
                        $(this).append(itemFields);
                    })
                    $("#sort").append(itemFields);

                    $(".deleteButton").click(function () {
                        $(this).parents("tr").remove();
                    });

                    $(".target_Fields,#sort").change(function () {
                        targetFieldChooseColumnShow($(this).children("option:selected").attr("id"));
                        $(this).parent("td").find("label").html("").append($(this).children("option:selected").attr("desc"));
                    });
                    targetFieldChooseColumnShow(-1);

                    //判断是否有关联表
                    var linkTableName = $("#linkTableName").html();
                    if(linkTableName!=''&&linkTableName!=undefined){

                        $("#linkDataTable").html("");
                        var itemE = "";
                        $.each(data.data, function (i, n) {
                            itemE += "<tr>" +
                                "<td style='width: 30%' ><label>" + n.fieldDes + "-" + n.fieldName + "</label><button  class='deleteButtonL' >删除</button></td>" +
                                "<td style='width: 70%'> <select id ='targetFields' class='target_fields_link'></select><label></label></td>" +
                                "</tr>";
                        })

                        $("#linkDataTable").append(itemE);
                        var itemFieldsE = "";
                        $("#linkTargetTable tr:first").find("td").each(function (i) {
                            var str = $(this).html();

                            itemFieldsE += "<option align='center' id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
                        })

                        $(".target_fields_link").each(function () {
                            $(this).append(itemFieldsE);
                        })

                        $(".deleteButtonL").click(function () {
                            $(this).parents("tr").remove();
                        });

                        $(".target_fields_link,#sort").change(function () {
                            targetLinkFieldChooseColumnShow($(this).children("option:selected").attr("id"));
                            $(this).parent("td").find("label").html("").append($(this).children("option:selected").attr("desc"));
                        });
                        targetLinkFieldChooseColumnShow(-1);

                    }

                    //清空过滤条件
                    $("#filterTable").empty();
                    $("#linkFilterTable").empty();
                    //清空附件节点属性
                    $("#startAttachTable").empty();
                    $("#endAttachTable").empty();

                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }
        });

    }

    var labelIndex=0;
    /*
    * 添加标签
    * */
    function addLabel(){
        var topLabelE = topLabelBegin+labelIndex+topLabelMiddleBegin+labelIndex+topLabelMiddleEnd+topLabelEnd;
        var subLabelE = subLabelBegin+labelIndex+subLabelEnd;
        labelIndex +=1;
        var trE = "<tr><td style='width: 10%'>"+topLabelE+"</td><td style='width: 10%'>===标签选择====</td><td style='width: 70%'>"+subLabelE+"&emsp;<button  class='labelButton' >删除</button></td> </tr> ";
        $("#labelTable").append(trE);

        $(".labelButton").click(function () {
            $(this).parents("tr").remove();
            labelIndex -=1;
        });
    }

    var topLabelBegin = "大类标签：<select id='topLabel";
    var topLabelMiddleBegin= "' onchange='selectSubLabel(";
    var topLabelMiddleEnd= ")'>";
    var topLabelEnd = "";
    /*
    * 获取所有的顶级标签，遍历
    * */
    function selectTopLabel(categoryId) {

        /*
        * 设置为不可用
        * */
        $("#addLabelId").attr("disabled",true);
        /*
        * 清空
        * */
        $("#labelTable").empty();
        labelIndex=0;
        topLabelEnd="";

        $.ajax({
            type: "post",
            url: url + "/category/getTopLabelList?categoryId="+categoryId,
            dataType: 'json',
            cache: false,
            success: function (output) {
                if (output == "" || output == undefined) {
                    topLabelEnd +="<option value=''>----请选择----</option>";
                    topLabelEnd+="</select>";
                    // alert('返回值为空!');
                } else {
                    //顶级标签菜单
                    topLabelEnd +="<option value=''>----请选择----</option>";
                    if(output.length>0) {
                        for(var i=0;i<output.length;i++) {
                            topLabelEnd +="<option value='"+output[i]["labelId"]+"'>"+output[i]['labelName']+"</option>";
                        }
                    }
                    topLabelEnd+="</select>";
                    //添加标签按钮可用
                    $("#addLabelId").removeAttr("disabled");
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("操作异常");
            }
        });

    }

    var subLabelBegin = "小类标签：<select id='subLabel";
    var subLabelEnd = "'><option value=''>----请选择----</option></select>";
    /*
     * 根据顶级标签获取小类标签
     * */
    function selectSubLabel(labelIndex) {
        $("#subLabel"+labelIndex).empty();
        $("#subLabel"+labelIndex).append("<option value=''>----请选择----</option>");
        var topLabelId = $("#topLabel"+labelIndex).val();
        if(topLabelId!='') {
            $.ajax({
                type: "post",
                url: url + "/category/getSubLabelListByTopLabelId?topLabelId=" + topLabelId,
                dataType: 'json',
                cache: false,
                success: function (output) {
                    if (output == "" || output == undefined) {
                        // alert('返回值为空!');
                    } else {
                        var subLabelE = "";
                        if (output.length > 0) {
                            for (var i = 0; i < output.length; i++) {
                                subLabelE +="<option value='" + output[i]["labelId"] + "'>" + output[i]['labelName'] + "</option>";
                            }
                        }
                        $("#subLabel"+labelIndex).append(subLabelE);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("操作异常");
                }
            });
        }else{

        }

    }

    /*开始节点和结束节点的下拉选择*/
    function setStartNodeAndEndNodeSelect(subId) {

        $.ajax({
            type: "post",
            url: url + "/category/startAndEnd?subId="+subId,
            dataType: 'json',
            cache: false,
            success: function (data) {
                if (data == "" || data == undefined) {
                    alert('返回值为空!');
                } else {
                    // console.log(data);
                    var startAttachSelectE = "<select id='startAttachSelectType' name='startAttachSelectType'><option value=''>===请选择===</option>";
                    var startData = data['startNode'];
                    if(startData!=undefined){
                        for(var i=0;i<startData.length;i++) {
                            startAttachSelectE += "<option value='"+startData[i].belongtoId+"-"+startData[i].fieldName+"'>"+startData[i].fieldName + " - " + startData[i].fieldDes+"</option>";
                        }
                        startAttachSelectE += "</select>";
                    }
                    beginNodeSelect = startAttachSelectE;

                    var endData = data['endNode'];
                    if(endData!=undefined){
                        var endAttachSelectE = "<select id='endAttachSelectType' name='endAttachSelectType'><option value=''>===请选择===</option>";
                        for (var i = 0; i < endData.length; i++) {
                            endAttachSelectE += "<option value='"+endData[i].belongtoId+"-"+ endData[i].fieldName + "'>" + endData[i].fieldName + " - " + endData[i].fieldDes + "</option>";
                        }
                        endAttachSelectE += "</select>";
                    }
                    endNodeSelect = endAttachSelectE;

                    //开始和结束节点标签名字
                    $("#startNodeDesc").html(data['startNodeDesc']);
                    $("#endNodeDesc").html(data['endNodeDesc']);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }
        });


    }

    /*附件条件的下拉字段*/
    var attachFieldSelectE = "";

    /*附件字段时，目标表的字段，主表字段一定有，有关联表时需要组合关联表字段*/
    function attachFieldSelect() {
        var itemFields = "<select id='attachSelectField' name='attachSelectField'><option value=''>===请选择===</option>";
        $("#targetTable tr:first").find("td").each(function (i) {
            var str = $(this).html();

            itemFields += "<option align='center' attach='0' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "-0'>" + str +"(主表)"+ "</option>";
        })

        //判断是否有关联表
        var linkTableName = $("#linkTableName").html();
        if(linkTableName!=''&&linkTableName!=undefined) {
            $("#linkTargetTable tr:first").find("td").each(function (i) {
                var str = $(this).html();

                itemFields += "<option align='center'  attach='1' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "-1'>" + str +"(关联表)"+"</option>";
            })
        }

        itemFields += "</select>";

        attachFieldSelectE = itemFields;


    }


    /*
     * 预览数据列
     * */
    function targetFieldChooseColumnShow(id) {
        if (id == -1) {
            id = 0;
        }
        var itemPreview = "";
        $("#data_preview").html("");
        $("#targetTable tr").each(function () {
            itemPreview += "<tr>" +
                "<td>" + $(this).children("td:eq(" + id + ")").html() + "</td>" +
                "</tr>";
        })
        $("#data_preview").append(itemPreview);
    }

    /*
     * 预览关联表数据列
     * */
    function targetLinkFieldChooseColumnShow(id) {
        if (id == -1) {
            id = 0;
        }
        var itemPreview = "";
        $("#linkDataPreview").html("");
        $("#linkTargetTable tr").each(function () {
            itemPreview += "<tr>" +
                "<td>" + $(this).children("td:eq(" + id + ")").html() + "</td>" +
                "</tr>";
        })
        $("#linkDataPreview").append(itemPreview);
    }


    /**
     * 添加主表过滤条件
     * */
    function addFilter(){
        var fieldE = "";
        $("#targetTable tr:first").find("td").each(function (i) {
            var str = $(this).html();
            fieldE += "<option id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
        });

        var eleSelectE = "<select name='condition' style='width: 300px;'>"+fieldE+"</select>";

        var trE = "<tr><td style='width: 30%'>"+eleSelectE+"</td><td style='width: 10%'>===等于====</td><td style='width: 30%'><input type='text' value=''/>&emsp;<button  class='deleteFilterButton' >删除</button></td> </tr> ";
        $("#filterTable").append(trE);

        $(".deleteFilterButton").click(function () {
            $(this).parents("tr").remove();
        });
    }

    /*关联表过滤条件*/
    function addLinkFilter(){
        var linkTableName = $("#linkTableName").html();
        if(linkTableName==''||linkTableName==undefined){
            alert("关联表不存在，不能进行关联表过滤条件添加");
            return ;
        }
        var fieldE = "";
        $("#linkTargetTable tr:first").find("td").each(function (i) {
            var str = $(this).html();
            fieldE += "<option id='" + i + "' desc ='" + str.substring(str.indexOf("-") + 1) + "' value='" + str.substring(0, str.indexOf("-")) + "'>" + str + "</option>";
        });

        var eleSelectE = "<select name='linkCondition' style='width: 300px;'>"+fieldE+"</select>";

        var trE = "<tr><td style='width: 30%'>"+eleSelectE+"</td><td style='width: 10%'>===等于====</td><td style='width: 30%'><input type='text' value=''/>&emsp;<button  class='deleteFilterButtonL' >删除</button></td> </tr> ";
        $("#linkFilterTable").append(trE);

        $(".deleteFilterButtonL").click(function () {
            $(this).parents("tr").remove();
        });
    }

    /*
    * 添加开始节点属性
    * */
    function addStartAttach() {
        var preTableName = $("#preTableName").html();
        if(preTableName==''||preTableName==undefined){
            alert("请选择主表");
            return;
        }

        var id = $("#categoryName").attr("num");
        if(id==''||id==undefined){
            alert("请选择需要绑定的小类");
            return;
        }

        var trE = "<tr><td style='width: 30%'>"+beginNodeSelect+"</td><td style='width: 10%'>===附件属性字段====</td><td style='width: 30%'>"+attachFieldSelectE+"&emsp;<button  class='startAttachButton' >删除</button></td> </tr> ";
        $("#startAttachTable").append(trE);

        $(".startAttachButton").click(function () {
            $(this).parents("tr").remove();
        });

    }

    /*
    * 添加结束节点属性
    * */
    function addEndAttach() {
        var preTableName = $("#preTableName").html();
        if(preTableName==''||preTableName==undefined){
            alert("请选择主表");
            return;
        }

        var id = $("#categoryName").attr("num");
        if(id==''||id==undefined){
            alert("请选择需要绑定的小类");
            return;
        }

        var trE = "<tr><td style='width: 30%'>"+endNodeSelect+"</td><td style='width: 10%'>===附件属性字段====</td><td style='width: 30%'>"+attachFieldSelectE+"&emsp;<button  class='endAttachButton' >删除</button></td> </tr> ";
        $("#endAttachTable").append(trE);

        $(".endAttachButton").click(function () {
            $(this).parents("tr").remove();
        });

    }


    /**
     * 绑定
     */
    function bindData() {

        // var bindSorting = $("#sort").val();
        // var occupation = $("#occupation").val();

        var fieldsList = [];
        $("#dataTable tr").each(function (i, n) {
            fieldsList.push($(this).children("td:eq(0)").find("label").html() + "-" + $(this).children("td:eq(1)").find("select").val() + "-0");

        })

        var sch = $("#dbSelect").children("option:selected").attr("sc");
        if (sch == undefined || sch == '' || sch == 'undefined') {

            sch = "";
        } else {
            sch += ".";
        }

        /*
        * 表名字
        * */
        var tables = [];
        tables.push(sch + $("#targetName").html());
        //关联表判断
        var linkTableName = $("#linkTableName").html();
        if(linkTableName!=''&&linkTableName!=undefined) {
            tables.push(sch + linkTableName);
            //关联表字段
            $("#linkDataTable tr").each(function (i, n) {
                fieldsList.push($(this).children("td:eq(0)").find("label").html() + "-" + $(this).children("td:eq(1)").find("select").val() + "-1");
            })
        }
        var sysDataBindOverviewStr = $("#dbSelect").children("option:selected").attr("value")
            + "-" + $("#categoryName").attr("num")
            + "-" + (parseInt($("#categoryName").attr("type")) + 1)
            + "-" + ($("#categoryName").attr("type") == 0 ? "【本体】" : "【关系】") + "绑定" + $("#categoryName").html().replace(" - ", "")
            + "(" + $("#targetName").html() + ")"
            + "-" + sch + $("#preTableName").attr("cname").replace("-", "");

        /*
        * 人员类型
        * */
        if ($("#personTypeLabel").css("visibility") == "visible") {
            if($("#personType").val()==''){
                alert("人员类型不能为空");
                return;
            }
            sysDataBindOverviewStr += "-" + $("#personType").val();
        }

        var data = {
            // "bindSorting": bindSorting,
            "fieldsList": fieldsList,
            "sysDataBindOverviewStr": sysDataBindOverviewStr,
            "tables": tables
        }

        //关联表存在，设置关联条件
        if(linkTableName!=''&&linkTableName!=undefined){
            var primaryTableKey = $("#primaryTableKey").val();
            var linkTablekey = $("#linkTablekey").val();
            if(linkTablekey==''||linkTablekey==undefined||primaryTableKey==''||primaryTableKey==undefined){
                alert("主表和关联表字段未进行关联");
                return;
            }
            var str = "1-"+linkTablekey+"-0-"+primaryTableKey;
            var conn = [];
            conn.push(str);
            data.connection = conn;
        }

        /*
        * 判断是否有标签
        * */
        var labelArr = [];
        $("#labelTable tr").each(function (i, n) {
            var subLabelE = $(this).children("td:eq(2)").find("select").val();
            if(subLabelE!='') {
                labelArr.push(subLabelE);
            }
        })

        if(labelArr.length>0) {
            data.labelArr = labelArr;
        }

        /*
        * 判断是否有过滤
        * */
        var filterList = [];
        $("#filterTable tr").each(function (i, n) {
            if($(this).children("td:eq(2)").find("input").val()!='') {
                filterList.push("0-" + $(this).children("td:eq(0)").find("select").val() + "-" + $(this).children("td:eq(2)").find("input").val());
            }
        })

        $("#linkFilterTable tr").each(function (i, n) {
            if($(this).children("td:eq(2)").find("input").val()!='') {
                filterList.push("1-" + $(this).children("td:eq(0)").find("select").val() + "-" + $(this).children("td:eq(2)").find("input").val());
            }
        })

        if(fieldsList.length>0) {
            data.filter = filterList;
        }


        /*
        * 开始节点和结束节点的附件属性判断
        * */
        var startCount=0;
        var endCount=0;
        var startDataBindAttach = [];
        var endDataBindAttach = [];
        //开始和结束节点附件字段
        $("#startAttachTable tr").each(function (i,n) {
            var localFieldE = $(this).children("td:eq(0)").find("select").val();
            var targetFieldE = $(this).children("td:eq(2)").find("select").val();
            //判断是否有空值
            if(localFieldE==''||targetFieldE==''){
                startCount++;
            }else{
                startDataBindAttach.push(localFieldE + "-" + targetFieldE);
            }

        })
        $("#endAttachTable tr").each(function (i,n) {
            var localFieldE = $(this).children("td:eq(0)").find("select").val();
            var targetFieldE = $(this).children("td:eq(2)").find("select").val();
            //判断是否有空值
            if(localFieldE==''||targetFieldE==''){
                endCount++;
            }else{
                endDataBindAttach.push(localFieldE + "-" + targetFieldE);
            }

        })

        if(startCount>0) {
            alert("开始节点附加属性值选择的不能为空");
            return ;
        }
        if(endCount>0) {
            alert("结束节点附加属性值选择的不能为空");
            return ;
        }

        if(startDataBindAttach.length>0) {
            data.startDataBindAttach = startDataBindAttach;
        }

        if(endDataBindAttach.length>0) {
            data.endDataBindAttach = endDataBindAttach;
        }

        console.log(data);
        $.ajax({
            type: "post",
            url: url + "/dataSyn/bindNewData",
            data: JSON.stringify(data),
            contentType: 'application/json;charset=utf-8',
            cache: false,
            success: function (data) {
                if (data == "" || data == undefined) {
                    alert('返回值为空!');
                } else {
                    console.log(data)
                    alert("绑定成功！")
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("获取数据异常");
            }

        })
    }

    /*
        * 去除关联表
        * */
    function removeLinkTable() {

        $("#primaryTableKey").empty();
        $("#linkTablekey").empty();
        $("#linkTargetTable").empty();
        $("#linkDataTable").empty();
        $("#linkTableName").html("");
        $("#linkDataPreview").empty();
        $("#linkFilterTable").empty();
        $("#startAttachTable").empty();
        $("#endAttachTable").empty();
        $("#startNodeDesc").html("");
        $("#endNodeDesc").html("");
        //隐藏连接
        $("#linkField").hide();
        //隐藏关联表绑定属性
        $("#linkShowTitle").hide();
        $("#linkShowTable").hide();
    }
</script>
</html>